<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정정게시판</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #FFF;
            margin: 0;
            padding: 0;
        }

        header {
            background: linear-gradient(90deg, #5b5fc7, #6B2399);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header-left img {
            width: 50px;
            height: 50px;
            margin-right: 20px;
        }

        .header-left h1 {
            font-size: 50px;
            color: #FFF;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-right span {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .header-right button {
            background-color: white;
            color: #333;
            font-size: 16px;
            font-weight: bold;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
        }

        .header-right button:hover {
            background-color: #f1f1f1;
        }


    </style>
    <link rel="stylesheet" type="text/css" href="/css/boardDetail.css" />
    <link rel="stylesheet" type="text/css" href="/css/modal.css"/>
</head>
<body>
<header>
    <div class="header-left">
        <a href="/user/userMain">
            <img src="/img/logo.png" alt="Mate Logo" class="logo-img">
        </a>
        <h1>정정게시판</h1>
    </div>
    <div class="header-right">
        <span>{{userName}}님 반갑습니다.</span>
        <button>마이페이지</button>
        <button>정정게시판</button>
        <form action="/signOut" method="post" style="display:inline;">
            <button type="submit" class="nav-button">로그아웃</button>
        </form>
    </div>
</header>
<!-- 모달창 -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>독성발언 조회</h2>

        <!-- 1. 미팅 선택 -->
        <div class="select-container">
            <label for="meetingSelect">미팅 선택:</label>
            <select id="meetingSelect" onchange="fetchToxicityLogs()">
                <option value="">미팅을 선택하세요</option>
                <option value="1">미팅 A</option>
                <option value="2">미팅 B</option>
                <option value="3">미팅 C</option>
                <option value="4">미팅 D</option>
            </select>
        </div>

        <!-- 2. 검색창 (미팅 선택 전에는 숨김) -->
        <div id="search-container" class="search-container">
            <span class="search-icon">🔍</span>
            <input type="text" id="searchInput" placeholder="독성 발언 검색..." onkeyup="filterList()">
        </div>

        <!-- 3. 독성 발언 리스트 (미팅 선택 전에는 숨김) -->
        <ul id="toxicity-list" class="toxicity-list">
            <!-- 독성 발언 리스트가 여기에 추가됨 -->
        </ul>

        <!-- 4. 선택 완료 버튼 -->
        <button id="confirmSelection" onclick="confirmToxicity()" style="display: none;">선택 완료</button>
    </div>
</div>
<!-- 메인 박스 -->
<div class="container">
    {{#feedback}} <!-- /user/userFix/detail 시 보이는 form -->
    <form>
        <input type="hidden" name="userId" value="{{userId}}" id="userId">
        <div class="read-group">
            <label for="title">제목</label>
            <input type="text" id="title" name="title" value="{{title}}" readonly>
        </div>
        <div class="read-group">
            <label for="dateInput">기간</label>
            <input id="dateInput" type="text" value="{{createdAt_format}}" name="createdAt" readonly>
        </div>
        <div class="read-group">
            <label for="toxicitySpeechLog">독성발언 조회</label>
            <input type="text" id="toxicitySpeechLog" name="toxicitySpeechLog" value="{{toxicitySpeechLog_time}} / {{toxicitySpeechLog}}" readonly>
        </div>
        <div class="read-file-upload">
            <label for="filepath_read">첨부 파일</label>
            <input type="text" id="filepath_read" name="filepath_read" value="{{filepath}}" readonly>
        </div>
        <div class="read-group">
            <label for="content">내용</label>
            <textarea id="content" rows="6" name="content" readonly>{{content}}</textarea>
        </div>
        <div class="btnArea">
            <button onclick="goback()" id="backbtn" type="button" class="submit-btn">뒤로가기</button>
        </div>
    </form>
    {{/feedback}}
    {{^feedback}} <!-- /user/userFix/write 시 보이는 form -->
    <form action="../userFix/write" method="post" enctype="multipart/form-data">
        <input type="hidden" name="userId" id="userId" value="{{userId}}">
        <div class="form-group">
            <label for="title">제목</label>
            <input type="text" id="title" name="title" placeholder="제목을 입력하세요">
        </div>
        <div class="form-group">
            <label for="date-range">기간</label>
            <input id="date-range" type="date" name="createdAt">
        </div>
        <div class="form-group">
            <label for="toxicityId">독성발언 조회</label>
            <input type="text" id="toxicityContent" name="toxicityContent" placeholder="독성발언을 선택하세요">
            <input type="hidden" id="toxicityId" name="toxicityId">
            <button type="button" id="searchBtn" onclick="openModal()" class="search-btn">조회</button>
        </div>
        <div class="file-upload">
            <label for="filepath">첨부 파일</label>
            <input type="file" id="filepath" name="filepath">
        </div>
        <div class="form-group">
            <label for="content">내용</label>
            <textarea id="content" rows="6" name="content" placeholder="내용을 입력하세요"></textarea>
        </div>
        <div class="btnArea">
            <button id="submitBtn" type="submit" class="submit-btn">제출하기</button>
            <button id="backBtn" onclick="goback()" type="button" class="submit-btn">뒤로가기</button>
        </div>
    </form>
    {{/feedback}}
</div>
</body>
<script>
    //userFix/detail js
    document.addEventListener("DOMContentLoaded", function() {

        //filepath빈값일 시 대체문구
        const filepath = document.getElementById("filepath_read");
        if (filepath) {
            if (filepath.value.trim() === "") {
                filepath.value = "업로드된 첨부파일이 없음";
            }
        }
    });

    function goback(){
        window.location.href = "/user/userFix";
    }
    /* 모달 */

    // 모달 열기
    function openModal() {
        document.getElementById("modal").style.display = "flex";
        loadMeetings(); // 미팅 리스트 로드
    }

    // 모달 닫기
    function closeModal() {
        document.getElementById("modal").style.display = "none";
    }

    // 미팅 목록 로드 (백엔드 API 호출)
    function loadMeetings() {
        const userId = document.getElementById("userId");
        console.log(">>> userId:"+userId.value);
        //ajax 요청(javascript)
        fetch("/meeting/user/meetingInfo",{
            method:"POST",
            headers : {
                "Content-Type" : "application/json"
            },
            body : JSON.stringify({userId : userId.value})
        })
        .then(response => response.json())
        .then(data => {
            console.log("미팅 정보 : ", data);
            updateMeetingDropdown(data);
        })
        .catch(error => console.error("미팅 데이터 로드 실패:", error));
    }
    //미팅리스트 셋팅
    function updateMeetingDropdown(meetings){
        const meetingSelect = document.getElementById("meetingSelect");
        // 기존 옵션 초기화 (첫 번째 기본 옵션 제외)
        meetingSelect.innerHTML = '<option value="">미팅을 선택하세요</option>';

        meetings.forEach(meeting => {
            const option = document.createElement("option");
            option.value = meeting.meetingId; // 미팅 ID
            option.textContent = meeting.meetingName; // 미팅 이름
            meetingSelect.appendChild(option);
        });

        console.log("미팅 드롭다운이 업데이트되었습니다:", meetings);
    }
    // 특정 미팅의 독성 발언 조회
    function fetchToxicityLogs() {
        const userId = document.getElementById("userId").value;
        const meetingId = document.getElementById("meetingSelect").value;
        const searchContainer = document.getElementById("search-container");
        console.log(">>> searchContainer"+searchContainer.style.display);
        const toxicityList = document.getElementById("toxicity-list");
        const confirmButton = document.getElementById("confirmSelection");
        //선택 미팅ID
        console.log(">>> meetingId : "+meetingId);

        if (!meetingId) {
            // 미팅을 선택하지않을 경우 UI 초기화
            resetToxicityList();
            return;
        }

        // 미팅을 선택하면 검색창, 리스트, 버튼 보이기
        searchContainer.style.display = "flex";
        toxicityList.style.display = "block";
        confirmButton.style.display = "block";

        //독성 발언 리스트 가져오기
        fetch("/toxic/userToxicLog",{
            method : "POST",
            headers : {"Content-Type" : "application/json"},
            body : JSON.stringify({meetingId : meetingId, userId: userId})
        })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                if(!response.ok){
                    throw new Error(`서버 응답 오류 : ${response.status}`); //404
                }
                return response.json();
            })
            .then(data => {
                console.log(">>> 독성발언 조회 결과 : ",data);
                updateToxicityList(data);
            })
            .catch(error =>{
                console.error("독성 발언 데이터 로드 실패:", error);
                resetToxicityList();
            });

    }
    //독성리스트 셋팅
    function updateToxicityList(toxicityLogs){
        const listContainer = document.getElementById("toxicity-list");
        listContainer.innerHTML = ""; //기존 목록 비우기
        console.log(">>> updateToxicityList", toxicityLogs);

        if(!toxicityLogs || toxicityLogs.length === 0){
            listContainer.innerHTML = "<li class='empty-message'>조회된 독성 발언이 없습니다.</li>";
            return;
        }

        toxicityLogs.forEach( log => {
            console.log(">> 리스트 생성",log.speechContent);
            const listItem = document.createElement("li");
            listItem.id = "txNum"+log.toxicityId;
            listItem.textContent = log.speechTimestamp+" / "+log.speechContent; //독성발언리스트표시
            listItem.classList.add("toxicity-item");

            listItem.addEventListener("click",function(){
                selectToxicity(this);
            });
            listContainer.appendChild(listItem);
        });
    }
    //독성 리스트 초기화
    function resetToxicityList() {
        document.getElementById("search-container").style.display = "none";
        document.getElementById("toxicity-list").style.display = "none";
        document.getElementById("confirmSelection").style.display = "none";
        document.getElementById("toxicity-list").innerHTML = "";
    }
    // 독성 발언 검색 필터
    function filterList() {
        const query = document.getElementById("searchInput").value.toLowerCase();
        document.querySelectorAll("#toxicity-list li").forEach(item => {
            item.style.display = item.textContent.toLowerCase().includes(query) ? "" : "none";
        });
    }

    // 독성 발언 선택
    let selectedContent = null;
    let selectedId = null;
    function selectToxicity(element) {
        document.querySelectorAll("#toxicity-list li").forEach(item => item.classList.remove("selected"));
        //현재 클릭된 요소에 "selected" 클래스 추가
        element.classList.add("selected");
        //선택된 텍스트 저장
        selectedContent = element.textContent;
        selectedId = element.id;
        console.log(">>> 선택된 독성 번호:", selectedId);
        console.log(">>> 선택된 독성 발언:", selectedContent);
    }

    // 선택 완료
    function confirmToxicity() {
        if (!selectedContent && !selectedId) {
            alert("독성 발언을 선택하세요!");
            return;
        }
        document.getElementById("toxicityContent").value = selectedContent;
        document.getElementById("toxicityId").value = selectedId.replace("txNum","");
        closeModal();
    }
</script>
</html>
